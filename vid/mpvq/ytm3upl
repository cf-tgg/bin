#!/bin/sh

pl="playlist.$(date +%Y%m%d_%H%M-%S).m3u8"
echo "#EXTM3U" > "$pl"
{ [ "$#" -gt 0 ] && printf "%s\n" "$@"; cat; } | while read -r url; do
    [ -z "$url" ] && continue
    case "$url" in
        http*|*youtube*|*youtu*) u="$url" ;;
        "[A-Za-z0-9_-]{11}") u="https://youtube.com/watch?v=$url" ;;
        *) echo "Invalid URL: $url" >&2 ; continue ;;
    esac
    d=$(yt-dlp -q --no-warnings --skip-download --get-duration "$u" 2>/dev/null | awk -F: 'NF==3 {print $1*3600+$2*60+$3}; NF==2 {print $1*60+$2}; NF==1 {print $1}')
    t=$(yt-dlp -q --no-warnings --skip-download --get-title "$u" 2>/dev/null)
    if [ -n "$d" ] && [ -n "$t" ]; then
        printf "#EXTINF:%s,%s\n%s\n" "$d" "$t" "$u" | tee -a "$pl"
    else
        echo "Failed to retrieve metadata for: $u" >&2
    fi
done

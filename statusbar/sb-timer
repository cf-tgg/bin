#!/bin/bash

TIMER_FILE="/tmp/dwmblocks_timer"
TIME=$(echo "" | dmenu -p "Set timer (e.g. 5m, 1h30m):")

if [ -z "$TIME" ]; then
    exit 0
fi

# Convert input time to seconds
convert_to_seconds() {
    time="$1"
    seconds=0

    if [[ "$time" =~ ([0-9]+)h ]]; then
        hours="${BASH_REMATCH[1]}"
        time="${time/${BASH_REMATCH[0]}/}"
        seconds=$((seconds + hours * 3600))
    fi

    if [[ "$time" =~ ([0-9]+)m ]]; then
        minutes="${BASH_REMATCH[1]}"
        time="${time/${BASH_REMATCH[0]}/}"
        seconds=$((seconds + minutes * 60))
    fi

    if [[ "$time" =~ ([0-9]+)s ]]; then
        seconds="${BASH_REMATCH[1]}"
    fi

    echo "$seconds"
}

SECONDS=$(convert_to_seconds "$TIME")

# Start countdown
while [ "$SECONDS" -gt 0 ]; do
    # Update timer in dwmblocks status bar
    printf "%02d:%02d:%02d" $((SECONDS/3600)) $((SECONDS/60%60)) $((SECONDS%60)) > "$TIMER_FILE"
    sleep 1
    SECONDS=$((SECONDS - 1))
done

# Clear the timer from status bar
echo "" > "$TIMER_FILE"

# Notify when the timer ends
notify-send "Timer Finished!" "Your countdown timer has ended."
tts "C'est fini ! fini j'ai dit !"

case $BLOCK_BUTTON in
  1) notify-send "$(display_timer)" ;;
  2) timer "$(dmenu -p 'Timer: ')" ;;
	3) notify-send "ðŸ•› Timer/date module" "-middle click to input timer duration" ;;

	6) emc "$0" ;;
esac

display_timer

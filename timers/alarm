#!/bin/bash
# Function to validate time format
validate_time_format() {
    # Regular expression to match time format
    local time_regex='^([0-1]?[0-9]|2[0-3]):([0-5]?[0-9])(:([0-5]?[0-9]))?$'

    # Validate time format
    if [[ $1 =~ $time_regex ]]; then
        return 0  # Valid format
    else
        return 1  # Invalid format
    fi
}

# Function to convert time to seconds
time_to_seconds() {
    local time_str="$1"
    local seconds=0
    IFS=':' read -r -a time_array <<< "$time_str"
    case ${#time_array[@]} in
        3)  # HH:MM:SS format
            seconds=$(( ${time_array[0]} * 3600 + ${time_array[1]} * 60 + ${time_array[2]} ))
            ;;
        2)  # HH:MM format
            seconds=$(( ${time_array[0]} * 3600 + ${time_array[1]} * 60 ))
            ;;
        1)  # Seconds only
            seconds=${time_array[0]}
            ;;
    esac
    echo "$seconds"
}

# Function to format seconds as HH:MM:SS
format_seconds() {
    local total_seconds=$1
    local hours=$((total_seconds / 3600))
    local minutes=$(( (total_seconds % 3600) / 60 ))
    local seconds=$((total_seconds % 60))
    printf "%02d:%02d:%02d" "$hours" "$minutes" "$seconds"
}

# Countdown timer function
countdown_timer() {
    local seconds="$1"
    while [ "$seconds" -gt 0 ]; do
        formatted_time=$(format_seconds "$seconds")
        echo -ne "  $formatted_time\033[0K\r"
        sleep 1
        : $((seconds--))
    done
    echo -e "\033[0K"  # Clear the countdown line
}

# Set default time format if not provided
if [ -z "$1" ]; then
    time_format='%S'  # Default to seconds
else
    time_format="$1"
fi

# Validate time format
if ! validate_time_format "$time_format"; then
    echo "Invalid time format. Please provide time in format HH:MM:SS, HH:MM, or SS."
    exit 1
fi

# Convert time to seconds
timeout_seconds=$(time_to_seconds "$time_format")

# Clear the terminal
clear;

# Start countdown timer in the background
countdown_timer "$timeout_seconds" &

# Read input with timeout in seconds
read -t "$timeout_seconds" || speaker-test -t sine -f 432
